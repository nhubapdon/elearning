<%- include("../../partials/db-header") %>

<main class="dash-main modern-ui main-offset">

  <div class="course-topbar">
    <div class="left">
      <h1 class="page-title">
        <% if (mode === 'edit') { %>
          Chỉnh sửa bài kiểm tra
        <% } else { %>
          Tạo bài kiểm tra mới
        <% } %>
      </h1>
      <p class="page-sub">
        Thiết kế bài kiểm tra trắc nghiệm cho khoá học, với câu hỏi và đáp án linh hoạt.
      </p>
    </div>

    <div class="right">
      <a href="/admin/quizzes" class="btn btn-outline-secondary rounded-pill">
        ← Quay lại danh sách
      </a>
    </div>
  </div>

  <form id="quizForm" method="POST" action="<%= mode === 'edit' ? ('/admin/quizzes/' + quiz.id) : '/admin/quizzes' %>">

    <div class="row g-4">
      <!-- LEFT: Quiz meta -->
      <div class="col-lg-4">
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-body">

            <div class="mb-3">
              <label class="form-label fw-semibold">Khoá học</label>
              <select name="course_id" class="form-select" <%= mode === 'edit' ? 'disabled' : '' %> required>
                <% (courses || []).forEach(c => { %>
                  <option value="<%= c.id %>"
                    <%= (mode === 'edit' && String(quiz.course_id) === String(c.id)) ? 'selected' : '' %>>
                    <%= c.title %>
                  </option>
                <% }) %>
              </select>
              <% if (mode === 'edit') { %>
                <!-- Nếu disable course_id, vẫn cần field hidden để submit -->
                <input type="hidden" name="course_id" value="<%= quiz.course_id %>">
              <% } %>
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">Tiêu đề bài kiểm tra</label>
              <input
                type="text"
                name="title"
                class="form-control"
                placeholder="VD: Bài kiểm tra cuối khoá"
                value="<%= quiz ? quiz.title : '' %>"
                required
              />
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">Tuỳ chọn</label>
              <div class="form-text">
                Hệ thống mặc định xét Pass nếu điểm ≥ 80%.
              </div>
            </div>

            <div class="d-flex flex-column gap-2">
              <button type="button"
                      id="btnPreviewQuiz"
                      class="btn btn-outline-primary rounded-pill w-100">
                <i class="bi bi-eye me-1"></i> Xem trước bài kiểm tra
              </button>

              <button type="submit" class="btn btn-success rounded-pill w-100">
                <i class="bi bi-check-circle me-1"></i>
                <%= mode === 'edit' ? 'Lưu thay đổi' : 'Tạo bài kiểm tra' %>
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT: Question builder -->
      <div class="col-lg-8">
        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0 fw-semibold">Câu hỏi & đáp án</h5>
              <button type="button"
                      id="btnAddQuestion"
                      class="btn btn-outline-primary rounded-pill btn-sm">
                <i class="bi bi-plus-circle me-1"></i> Thêm câu hỏi
              </button>
            </div>

            <p class="text-muted small mb-3">
              Mỗi câu hỏi có tối đa 4 đáp án trắc nghiệm. Chọn một đáp án đúng cho mỗi câu.
            </p>

            <div id="questionsBox" class="question-builder-list">
              <!-- JS sẽ render câu hỏi từ window.quizInitialQuestions -->
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Hidden field để đẩy JSON câu hỏi -->
    <input type="hidden" name="questions" id="questionsJson">

  </form>

</main>


<script>
  window.quizMode = "<%= mode %>";
  window.quizInitialQuestions = <%- JSON.stringify(questions || []) %>;
</script>
<!-- ========== ADD THIS PREVIEW MODAL ========== -->
<div class="modal fade" id="quizPreviewModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title">Xem trước bài kiểm tra</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="previewContent"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>
<!-- Bootstrap JS (Cần cho Modal hoạt động) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/js/dashboard-quiz-builder.js"></script>

<%- include("../../partials/db-footer") %>
