<%- include("../../partials/db-header") %>
<link rel="stylesheet" href="/assets/css/admin-quizzes.css">

<main class="dash-main modern-ui admin-quiz-page main-offset">

<%
// Helper: format date
function formatDate(d) {
  if (!d) return "";
  const date = new Date(d);
  return date.toLocaleString("vi-VN");
}
%>

<div class="admin-quiz-detail-page">

  <!-- Header + Back -->
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <h1 class="page-title mb-2">Chi tiết bài kiểm tra</h1>
      <p class="text-muted mb-1">
        <i class="bi bi-mortarboard-fill me-1"></i>
        Khóa học: <span class="fw-semibold"><%= quiz.course_title %></span>
      </p>
      <p class="text-muted mb-0">
        <i class="bi bi-card-checklist me-1"></i>
        Bài kiểm tra: <span class="fw-semibold"><%= quiz.title %></span>
      </p>
    </div>

    <div class="d-flex gap-2">
      <a href="/admin/quizzes" class="btn btn-light rounded-pill">
        <i class="bi bi-arrow-left-short me-1"></i> Quay lại danh sách
      </a>
    </div>
  </div>

  <!-- Stats cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Lượt làm bài</div>
        <div class="stat-value"><%= totalAttempts %></div>
        <div class="stat-sub">
          <i class="bi bi-people-fill me-1"></i>
          Tổng số học viên đã làm bài này
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Điểm trung bình</div>
        <div class="stat-value"><%= avgScore %><span class="stat-unit">%</span></div>
        <div class="stat-sub">
          <i class="bi bi-graph-up-arrow me-1"></i>
          Trung bình trên tất cả lượt làm bài
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Tỉ lệ Pass (≥ 80%)</div>
        <div class="stat-value"><%= stats.passRate %><span class="stat-unit">%</span></div>
        <div class="stat-sub">
          <span class="badge bg-success-soft text-success me-1">
            <i class="bi bi-check2-circle me-1"></i>
            Pass: <%= stats.passCount %>
          </span>
          <span class="badge bg-danger-soft text-danger">
            <i class="bi bi-x-circle me-1"></i>
            Fail: <%= stats.failCount %>
          </span>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Phân bố điểm</div>
        <div class="stat-distribution">
          <% const total = stats.total || 1; %>
          <div class="dist-bar">
            <div
              class="dist-seg dist-low"
              style="width:<%= (stats.buckets['0_49'] / total) * 100 %>%"
              title="0 - 49%">
            </div>
            <div
              class="dist-seg dist-mid"
              style="width:<%= (stats.buckets['50_79'] / total) * 100 %>%"
              title="50 - 79%">
            </div>
            <div
              class="dist-seg dist-high"
              style="width:<%= (stats.buckets['80_100'] / total) * 100 %>%"
              title="80 - 100%">
            </div>
          </div>
          <div class="dist-legend mt-1">
            <span class="legend-item">
              <span class="dot dot-low"></span> 0-49: <%= stats.buckets['0_49'] %>
            </span>
            <span class="legend-item">
              <span class="dot dot-mid"></span> 50-79: <%= stats.buckets['50_79'] %>
            </span>
            <span class="legend-item">
              <span class="dot dot-high"></span> 80-100: <%= stats.buckets['80_100'] %>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Table attempts -->
  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Danh sách lượt làm bài</h5>
      <span class="text-muted small">
        <i class="bi bi-info-circle me-1"></i>
        Bấm "Chi tiết" để xem học viên làm đúng/sai từng câu.
      </span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table align-middle mb-0 quiz-detail-table">
          <thead>
            <tr>
              <th class="text-center" style="width:60px;">#</th>
              <th>Học viên</th>
              <th class="text-center" style="width:120px;">Điểm</th>
              <th class="text-center" style="width:160px;">Đúng / Tổng</th>
              <th class="text-center" style="width:120px;">Trạng thái</th>
              <th class="text-center" style="width:180px;">Thời gian làm</th>
              <th class="text-end" style="width:120px;">Hành động</th>
            </tr>
          </thead>
          <tbody>
            <% if (detailedResults.length === 0) { %>
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  Chưa có học viên nào làm bài kiểm tra này.
                </td>
              </tr>
            <% } else { %>
              <% detailedResults.forEach((r, idx) => { %>
                <% const isPass = (Number(r.score) || 0) >= 80; %>
                <tr>
                  <td class="text-center text-muted">#<%= detailedResults.length - idx %></td>
                  <td>
                    <div class="fw-semibold"><%= r.user %></div>
                  </td>
                  <td class="text-center">
                    <span class="score-badge <%= isPass ? 'score-pass' : 'score-fail' %>">
                      <%= r.score %>%
                    </span>
                  </td>
<td class="text-center">
  <span class="correct-badge">
    <i class="bi bi-check2-circle me-1"></i>
    <%= r.correctCount %> / <%= r.totalQuestions %> câu
  </span>
</td>

                  <td class="text-center">
                    <% if (isPass) { %>
                      <span class="badge bg-success-soft text-success">
                        <i class="bi bi-check-circle me-1"></i> Pass
                      </span>
                    <% } else { %>
                      <span class="badge bg-danger-soft text-danger">
                        <i class="bi bi-x-circle me-1"></i> Fail
                      </span>
                    <% } %>
                  </td>
                  <td class="text-center text-muted">
                    <%= formatDate(r.taken_at) %>
                  </td>
                  <td class="text-end">
<button
  type="button"
  class="btn btn-sm btn-info-soft rounded-pill js-view-attempt"
  data-id="<%= r.id %>"
>
  <i class="bi bi-eye-fill me-1"></i> Chi tiết
</button>

                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>



</div>




</main>
  <!-- Modal xem chi tiết 1 lượt làm bài -->
  <div class="modal fade" id="attemptDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
      <div class="modal-content rounded-4">
        <div class="modal-header border-0">
          <h5 class="modal-title">
            Chi tiết lượt làm bài
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body" id="attemptDetailBody">
          <!-- JS sẽ render nội dung ở đây -->
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">
            Đóng
          </button>
        </div>
      </div>
    </div>
  </div>
<script>
  window.__QUIZ_DETAIL_DATA__ = <%- JSON.stringify(detailedResults || []) %>;
</script>
<script src="/assets/js/quiz-detail.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<%- include("../../partials/db-footer") %>
