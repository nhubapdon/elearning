<%- include("../../partials/db-header") %>
<link rel="stylesheet" href="/assets/css/admin-quizzes.css">

<main class="dash-main modern-ui admin-quiz-page main-offset">

  <!-- TOPBAR -->
  <div class="course-topbar">
    <div class="left">
      <h1 class="page-title">Qu·∫£n l√Ω b√†i ki·ªÉm tra</h1>
      <p class="page-sub">
        <% if (user && user.role === 'admin') { %>
          Qu·∫£n l√Ω to√†n b·ªô b√†i ki·ªÉm tra c·ªßa t·∫•t c·∫£ kh√≥a h·ªçc tr√™n h·ªá th·ªëng.
        <% } else { %>
          Qu·∫£n l√Ω c√°c b√†i ki·ªÉm tra thu·ªôc nh·ªØng kh√≥a h·ªçc b·∫°n ƒëang gi·∫£ng d·∫°y.
        <% } %>
      </p>
    </div>

    <div class="right d-flex gap-2">
      <a href="/admin/quizzes/export/csv" class="btn btn-outline-secondary rounded-pill">
        <i class="bi bi-download me-1"></i> Export CSV
      </a>

<!-- Import Excel (Preview Upload) -->
<div class="d-flex align-items-center gap-2">
  <label class="btn btn-outline-primary rounded-pill mb-0" style="cursor:pointer;">
    <i class="bi bi-file-earmark-excel me-1"></i> Import Excel
    <input id="importExcelInput" type="file" accept=".xlsx,.xls" hidden>
  </label>
</div>

      <a href="/admin/quizzes/export/template"
   class="btn btn-outline-info rounded-pill">
   üìÑ T·∫£i file m·∫´u
</a>

      <a href="/admin/quizzes/new" class="btn btn-primary rounded-pill">
        <i class="bi bi-plus-circle me-1"></i> T·∫°o b√†i ki·ªÉm tra
      </a>
    </div>
  </div>

<!-- FILTER BAR -->
<form class="filter-bar" method="GET" action="/admin/quizzes">

  <!-- Search -->
  <div class="filter-item search-item">
    <div class="search-box">
      <i class="bi bi-search"></i>
      <input
        type="text"
        name="search"
        placeholder="T√¨m b√†i ki·ªÉm tra..."
        value="<%= filters?.search || '' %>"
      />
    </div>
  </div>

  <!-- Filter by course -->
  <div class="filter-item">
    <label>Kho√° h·ªçc</label>
    <select 
      name="course_id"
      onchange="this.form.submit()"
    >
      <option value="">T·∫•t c·∫£</option>
      <% (courses || []).forEach(c => { %>
        <option 
          value="<%= c.id %>" 
          <%= (String(filters?.course_id || '') === String(c.id)) ? 'selected' : '' %>
        >
          <%= c.title %>
        </option>
      <% }) %>
    </select>
  </div>

  <!-- Reset -->
  <div class="filter-item filter-reset">
    <a href="/admin/quizzes" class="btn-reset">
      <i class="bi bi-arrow-clockwise me-1"></i> Xo√° b·ªô l·ªçc
    </a>
  </div>

</form>


  <!-- TABLE WRAPPER -->
  <div class="course-table-wrapper">
    <div class="table-header-row">
      <div class="col col-id">ID</div>
      <div class="col col-title">Ti√™u ƒë·ªÅ</div>
      <div class="col col-course">Kho√° h·ªçc</div>
      <div class="col col-questions">S·ªë c√¢u h·ªèi</div>
      <div class="col col-created">Ng√†y t·∫°o</div>
      <div class="col col-actions text-end">H√†nh ƒë·ªông</div>
    </div>

    <div class="table-body">

      <% if (!quizzes || quizzes.length === 0) { %>
        <div class="empty-state">
          <div class="emoji">üìù</div>
          <h4>Ch∆∞a c√≥ b√†i ki·ªÉm tra n√†o</h4>
          <p>H√£y t·∫°o b√†i ki·ªÉm tra ƒë·∫ßu ti√™n cho kho√° h·ªçc c·ªßa b·∫°n.</p>
        </div>
      <% } %>

      <% (quizzes || []).forEach(q => { %>
        <div class="table-row">
          <div class="col col-id">#<%= q.id %></div>

          <div class="col col-title">
            <div class="title"><%= q.title %></div>
          </div>

          <div class="col col-course">
            <div class="badge badge-soft-primary quiz-course-name">
              <i class="bi bi-journal-code me-1"></i>
              <%= q.course_title || '‚Äî' %>
            </div>
          </div>

          <div class="col col-questions">
            <span class="badge badge-soft-indigo">
              <i class="bi bi-list-ol me-1"></i>
              <%= q.question_count || 0 %> c√¢u
            </span>
          </div>

          <div class="col col-created">
            <%= new Date(q.created_at).toLocaleDateString('vi-VN') %>
          </div>

<div class="col col-actions text-end">
  <div class="action-buttons d-flex align-items-center gap-2 justify-content-end">

      <!-- N√∫t xem chi ti·∫øt -->
      <a href="/admin/quizzes/<%= q.id %>/detail"
         class="btn-action view"
         title="Xem chi ti·∫øt k·∫øt qu·∫£">
         <i class="bi bi-bar-chart-line"></i>
      </a>

      <!-- N√∫t ch·ªânh s·ª≠a -->
      <a href="/admin/quizzes/<%= q.id %>/edit"
         class="btn-action edit"
         title="Ch·ªânh s·ª≠a b√†i ki·ªÉm tra">
         <i class="bi bi-pencil-square"></i>
      </a>

      <!-- N√∫t xo√° -->
      <form action="/admin/quizzes/<%= q.id %>/delete"
            method="POST"
            class="d-inline"
            onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° b√†i ki·ªÉm tra n√†y kh√¥ng?');">
        <button class="btn-action delete" title="Xo√° b√†i ki·ªÉm tra">
          <i class="bi bi-trash"></i>
        </button>
      </form>

  </div>
</div>

        </div>
      <% }) %>

    </div>

    <!-- PAGINATION -->
    <div class="table-footer pager-wrapper">
      <% if (pagination && pagination.totalItems > 0) { %>
        <div class="table-info">
          Hi·ªÉn th·ªã <%= pagination.from %> - <%= pagination.to %> /
          <%= pagination.totalItems %> b√†i ki·ªÉm tra
        </div>
      <% } %>

      <div class="pager">
        <% if (pagination && pagination.totalPages > 1) { %>
          <% const baseUrl = "/admin/quizzes?search=" + (filters?.search || "") + "&course_id=" + (filters?.course_id || ""); %>

          <% if (pagination.page > 1) { %>
            <a class="pager-link" href="<%= baseUrl %>&page=<%= pagination.page - 1 %>">Prev</a>
          <% } else { %>
            <span class="pager-link disabled">Prev</span>
          <% } %>

          <% for (let i = 1; i <= pagination.totalPages; i++) { %>
            <% if (i === pagination.page) { %>
              <span class="pager-page active"><%= i %></span>
            <% } else { %>
              <a class="pager-page" href="<%= baseUrl %>&page=<%= i %>"><%= i %></a>
            <% } %>
          <% } %>

          <% if (pagination.page < pagination.totalPages) { %>
            <a class="pager-link" href="<%= baseUrl %>&page=<%= pagination.page + 1 %>">Next</a>
          <% } else { %>
            <span class="pager-link disabled">Next</span>
          <% } %>
        <% } %>
      </div>
    </div>
  </div>

</main>
<!-- Modal Preview Import -->
<div class="modal fade" id="importPreviewModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title fw-bold">Xem tr∆∞·ªõc d·ªØ li·ªáu Import</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="importPreviewContent" class="p-2"></div>
      </div>

      <div class="modal-footer">
        <form id="finalImportForm" action="/admin/quizzes/import" method="POST" enctype="multipart/form-data">
          <input type="file" id="finalImportFile" name="file" hidden>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hu·ª∑</button>
          <button type="submit" class="btn btn-success">X√°c nh·∫≠n Import</button>
        </form>
      </div>

    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="/assets/js/admin-quiz-import.js"></script>
<!-- Bootstrap JS (C·∫ßn cho Modal ho·∫°t ƒë·ªông) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/js/dashboard-quiz-builder.js"></script>
<%- include("../../partials/db-footer") %>
