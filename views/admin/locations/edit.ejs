<%- include("../../partials/db-header") %>

<main class="dash-main modern-ui main-offset">

  <div class="page-header d-flex justify-content-between align-items-center">
    <h2>Chỉnh sửa cơ sở</h2>
    <a href="/admin/locations" class="btn btn-light">
      <i class="bi bi-arrow-left"></i> Quay lại
    </a>
  </div>

  <div class="row g-4">

    <!-- LEFT COLUMN -->
    <div class="col-lg-5">
      <div class="card p-4 shadow-sm">

        <h5 class="mb-3 fw-semibold">Thông tin cơ sở</h5>

        <form action="/admin/locations/edit/<%= location.id %>" method="POST">

          <div class="mb-3">
            <label class="form-label">Tên cơ sở</label>
            <input type="text" name="name"
                   class="form-control"
                   value="<%= location.name %>" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Loại cơ sở</label>
            <select name="category" class="form-select" required>
              <option value="center"   <%= location.category==="center"?"selected":"" %>>Trung tâm</option>
              <option value="lab"      <%= location.category==="lab"?"selected":"" %>>Phòng lab</option>
              <option value="workshop" <%= location.category==="workshop"?"selected":"" %>>Workshop</option>
              <option value="exam"     <%= location.category==="exam"?"selected":"" %>>Điểm thi</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Địa chỉ</label>
            <input type="text" name="address"
              id="addressInput"
              class="form-control"
              value="<%= location.address %>" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Số điện thoại</label>
            <input type="text" name="phone"
              class="form-control"
              value="<%= location.phone || '' %>">
          </div>

          <div class="mb-3">
            <label class="form-label">Giờ mở cửa</label>
            <input type="text" name="opening_hours"
              class="form-control"
              placeholder="08:00 - 21:00"
              value="<%= location.opening_hours || '' %>">
          </div>

          <div class="row">
            <div class="col-6">
              <label class="form-label">Latitude</label>
              <input type="number" step="0.000001"
                     id="latInput"
                     class="form-control"
                     name="lat"
                     value="<%= location.lat %>"
                     required readonly>
            </div>
            <div class="col-6">
              <label class="form-label">Longitude</label>
              <input type="number" step="0.000001"
                     id="lngInput"
                     class="form-control"
                     name="lng"
                     value="<%= location.lng %>"
                     required readonly>
            </div>
          </div>

          <button type="button" id="openPreview" class="btn btn-primary w-100 mt-4">
  Xem trước & Lưu
</button>


        </form>

      </div>
    </div>

    <!-- RIGHT COLUMN (MAP) -->
    <div class="col-lg-7">
      <div class="card p-3 shadow-sm">

        <h5 class="fw-semibold mb-2">Chọn vị trí trên bản đồ</h5>

        <!-- Search box identical to create.ejs -->
        <div class="admin-map-search-box">
          <i class="bi bi-geo-alt search-icon"></i>
          <input 
            id="searchAddress"
            type="text"
            placeholder="Tìm vị trí trên bản đồ..."
            autocomplete="off"
          >
          <button type="button" id="searchBtn">
            <i class="bi bi-search"></i>
          </button>
        </div>

        <!-- MAP identical to create -->
        <div id="adminMap" style="height:480px;border-radius:12px;"></div>

        <button type="button" id="resetBtn" class="btn btn-outline-secondary mt-3">
          Reset về vị trí đã lưu
        </button>

      </div>
    </div>

  </div>

</main>
<!-- MODAL PREVIEW -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg border-0" style="border-radius:18px;">
      
      <div class="modal-header">
        <h5 class="modal-title fw-semibold">Xem trước thông tin cơ sở</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div class="row g-3">

          <div class="col-6">
            <label class="fw-semibold">Tên cơ sở:</label>
            <div id="pv_name" class="preview-value"></div>
          </div>

          <div class="col-6">
            <label class="fw-semibold">Loại:</label>
            <div id="pv_category" class="preview-badge"></div>
          </div>

          <div class="col-12">
            <label class="fw-semibold">Địa chỉ:</label>
            <div id="pv_address" class="preview-value"></div>
          </div>

          <div class="col-6">
            <label class="fw-semibold">Số điện thoại:</label>
            <div id="pv_phone" class="preview-value"></div>
          </div>

          <div class="col-6">
            <label class="fw-semibold">Giờ mở cửa:</label>
            <div id="pv_opening" class="preview-value"></div>
          </div>

          <div class="col-6">
            <label class="fw-semibold">Latitude:</label>
            <div id="pv_lat" class="preview-value code"></div>
          </div>

          <div class="col-6">
            <label class="fw-semibold">Longitude:</label>
            <div id="pv_lng" class="preview-value code"></div>
          </div>

        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Quay lại</button>
        <button id="confirmSubmit" class="btn btn-primary">
          Xác nhận & Lưu
        </button>
      </div>

    </div>
  </div>
</div>


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Bootstrap JS (Cần cho Modal hoạt động) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script src="/assets/js/admin-map.js"></script>

<%- include("../../partials/db-footer") %>
