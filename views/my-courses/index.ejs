<%- include("../partials/header") %>
<link rel="stylesheet" href="/assets/css/my-courses.css">

<section class="dashboard-hero">
  <div class="container">
    <div class="hero-inner">
      <h1 class="dashboard-title">Kh√≥a h·ªçc c·ªßa t√¥i</h1>
      <p class="dashboard-sub">Theo d√µi ti·∫øn tr√¨nh h·ªçc t·∫≠p, ti·∫øp t·ª•c h√†nh tr√¨nh tri th·ª©c c·ªßa b·∫°n.</p>
      <div class="dashboard-stats">
        <div class="stat-box">
          <i class="bi bi-book"></i>
          <div>
            <span><%= courses.length %></span>
            <label>Kh√≥a h·ªçc ƒë√£ ƒëƒÉng k√Ω</label>
          </div>
        </div>
        <div class="stat-box">
          <i class="bi bi-bar-chart-line"></i>
          <div>
            <span>68%</span>
            <label>Ti·∫øn ƒë·ªô trung b√¨nh</label>
          </div>
        </div>
        <div class="stat-box">
          <i class="bi bi-award"></i>
          <div>
            <span>3</span>
            <label>Kh√≥a h·ªçc ƒë√£ ho√†n th√†nh</label>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="container py-5">
  <% if (courses.length > 0) { %>
    <div class="course-grid">
      <% courses.forEach(course => { 
        const progress = Math.floor(Math.random() * 100); // demo % h·ªçc t·∫°m
        const completed = progress >= 100;
      %>
        <div class="course-card">
          <div class="thumb-wrapper">
            <img src="<%= course.thumbnail && course.thumbnail.trim() !== '' ? course.thumbnail : '/assets/images/default-course.jpg' %>" alt="<%= course.title %>">
            <% if (completed) { %>
              <div class="badge-complete">
                <i class="bi bi-check2-circle"></i> Ho√†n th√†nh
              </div>
            <% } %>
          </div>
          <div class="card-body">
            <h5><%= course.title %></h5>
            <p><%= (course.description || '').substring(0, 90) %>...</p>
            <div class="progress-container">
              <div class="progress-label"><%= progress %>% ho√†n th√†nh</div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: <%= progress %>%"></div>

              </div>
            </div>
            <p class="enrolled-date">ƒêƒÉng k√Ω: <%= new Date(course.enrolled_at).toLocaleDateString() %></p>
            <a href="/courses/<%= course.id %>" class="btn-learn">
              <i class="bi bi-play-circle"></i> <%= completed ? 'Xem l·∫°i kh√≥a h·ªçc' : 'Ti·∫øp t·ª•c h·ªçc' %>
            </a>
          </div>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <div class="empty-state">
      <img src="/assets/images/empty.png" alt="Empty">
      <h4>B·∫°n ch∆∞a mua kh√≥a h·ªçc n√†o üò¢</h4>
      <a href="/courses">Kh√°m ph√° kh√≥a h·ªçc</a>
    </div>
  <% } %>
</section>
<section class="container py-5 mt-4">
  <div class="assignment-panel">

    <!-- HEADER + FILTERS chung 1 h√†ng -->
    <div class="assignment-header">

      <!-- LEFT: Title + Subtext -->
      <div class="assignment-title-block">
        <h2 class="panel-title">B√†i t·∫≠p ƒë√£ n·ªôp</h2>
        <p class="panel-sub">Theo d√µi to√†n b·ªô b√†i t·∫≠p ƒë√£ n·ªôp t·ª´ t·∫•t c·∫£ c√°c kho√° h·ªçc c·ªßa b·∫°n.</p>
      </div>

      <!-- RIGHT: FILTERS -->
      <div class="assignment-filters">
        
        <!-- Filter kh√≥a h·ªçc -->
        <select id="filter-course" class="filter-select">
          <option value="">T·∫•t c·∫£ kh√≥a h·ªçc</option>
        </select>

        <!-- Filter tr·∫°ng th√°i -->
        <select id="filter-status" class="filter-select">
          <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
          <option value="graded">ƒê√£ ch·∫•m</option>
          <option value="pending">Ch∆∞a ch·∫•m</option>
        </select>

        <!-- Filter ƒëi·ªÉm -->
        <select id="filter-score" class="filter-select">
          <option value="">T·∫•t c·∫£ ƒëi·ªÉm</option>
          <option value="high">ƒêi·ªÉm cao (>= 8)</option>
          <option value="medium">ƒêi·ªÉm TB (5 ‚Äì 7)</option>
          <option value="low">ƒêi·ªÉm th·∫•p (< 5)</option>
        </select>

      </div>
    </div>

    <!-- TABLE -->
    <div class="table-responsive mt-3">
      <table class="lux-table" id="assignment-table">
        <thead>
          <tr>
            <th>B√†i t·∫≠p</th>
            <th>Kho√° h·ªçc</th>
            <th>N·ªôp l√∫c</th>
            <th>ƒêi·ªÉm</th>
            <th>Nh·∫≠n x√©t</th>
            <th>Chi ti·∫øt</th>
          </tr>
        </thead>
        <tbody id="assignments-body">
          <tr><td colspan="6" class="loading-row">ƒêang t·∫£i...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- PAGINATION -->
    <div id="assignment-pagination" class="pagination-wrapper"></div>

  </div>
</section>


<script>

let rawAssignments = []; // l∆∞u d·ªØ li·ªáu th√¥ t·ª´ API

/* =============================
    LOAD ASSIGNMENTS + PAGINATION
============================= */
function loadAssignments(page = 1) {
  fetch(`/my-courses/assignments/all?page=${page}`)
    .then(res => res.json())
    .then(data => {

      rawAssignments = data.assignments; // l∆∞u ƒë·ªÉ filter

      renderTable(data.assignments);
      renderPagination(data.totalPages, data.page);
      updateCourseFilter(data.assignments);
    });
}

/* =============================
    RENDER TABLE
============================= */
function renderTable(list) {
  const body = document.getElementById("assignments-body");

  if (!list.length) {
    body.innerHTML = `
      <tr><td colspan="6" class="empty-row">Kh√¥ng c√≥ b√†i t·∫≠p ph√π h·ª£p.</td></tr>
    `;
    return;
  }

  body.innerHTML = list.map(a => `
    <tr>
      <td><strong>${a.assignment_title}</strong></td>
      <td>${a.course_title}</td>
      <td>${new Date(a.submitted_at).toLocaleString("vi-VN")}</td>
      <td>${getScoreBadge(a.score, a.max_score)}</td>
      <td>${a.feedback || "‚Äî"}</td>
      <td><a href="/assignments/${a.assignment_id}" class="btn-view-table">Xem</a></td>
    </tr>
  `).join("");
}

/* =============================
    RENDER PAGINATION
============================= */
function renderPagination(totalPages, currentPage) {
  const pagination = document.getElementById("assignment-pagination");

  let html = "";
  for (let i = 1; i <= totalPages; i++) {
    html += `
      <button 
        onclick="loadAssignments(${i})"
        class="page-btn ${i === currentPage ? 'active' : ''}">
        ${i}
      </button>
    `;
  }

  pagination.innerHTML = html;
}

/* =============================
    SCORE COLOR LOGIC
============================= */
function getScoreBadge(score, max) {
  if (score === null) return `<span class="pending-badge-table">‚è≥ Ch∆∞a ch·∫•m</span>`;

  const ratio = score / max * 10;

  if (ratio >= 8)
    return `<span class="score-badge-high">‚≠ê ${score} / ${max}</span>`;

  if (ratio >= 5)
    return `<span class="score-badge-medium">‚≠ê ${score} / ${max}</span>`;

  return `<span class="score-badge-low">‚≠ê ${score} / ${max}</span>`;
}

/* =============================
    FILTER: UPDATE COURSE DROPDOWN
============================= */
function updateCourseFilter(list) {
  const select = document.getElementById("filter-course");

  const uniqueCourses = [...new Set(list.map(a => a.course_title))];

  select.innerHTML = `
    <option value="">T·∫•t c·∫£ kh√≥a h·ªçc</option>
    ${uniqueCourses.map(c => `<option value="${c}">${c}</option>`).join("")}
  `;
}

/* =============================
    APPLY FILTERS
============================= */
function applyFilters() {
  let filtered = [...rawAssignments];

  const course = document.getElementById("filter-course").value;
  const status = document.getElementById("filter-status").value;
  const score = document.getElementById("filter-score").value;

  // Filter kh√≥a h·ªçc
  if (course) {
    filtered = filtered.filter(a => a.course_title === course);
  }

  // Filter tr·∫°ng th√°i ch·∫•m ƒëi·ªÉm
  if (status === "graded") {
    filtered = filtered.filter(a => a.score !== null);
  }
  else if (status === "pending") {
    filtered = filtered.filter(a => a.score === null);
  }

  // Filter m·ª©c ƒëi·ªÉm
  if (score === "high") {
    filtered = filtered.filter(a => a.score !== null && a.score >= 8);
  }
  else if (score === "medium") {
    filtered = filtered.filter(a => a.score !== null && a.score >= 5 && a.score < 8);
  }
  else if (score === "low") {
    filtered = filtered.filter(a => a.score !== null && a.score < 5);
  }

  renderTable(filtered);
}

/* =============================
    EVENT LISTENERS
============================= */
document.getElementById("filter-course").onchange = applyFilters;
document.getElementById("filter-status").onchange = applyFilters;
document.getElementById("filter-score").onchange = applyFilters;

/* =============================
    INIT
============================= */
loadAssignments();

</script>



<%- include("../partials/footer") %>
